---
phase: 03-ai-scoping-assistant
plan: 02
type: execute
---

<objective>
Parse Claude's JSON response and display structured scope estimate with staffing, costs, confidence, and margins.

Purpose: Transform the raw AI response into a polished, professional display that proves historical data powers intelligent scoping — the "wow moment" for the Wednesday client presentation.
Output: Beautifully formatted scope estimate display with staffing table, cost breakdown, confidence notes, and margin recommendation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/02-dashboard-rate-card/02-01-SUMMARY.md
@.planning/phases/03-ai-scoping-assistant/03-01-SUMMARY.md

# Key source files:
@src/pages/AIScopingPage.tsx
@src/lib/ai.ts
@src/types/ai-context.ts
@src/lib/data.ts
@src/pages/DashboardPage.tsx

**Tech stack available:** Vite 7, React 19, TypeScript, Tailwind CSS v4, shadcn/ui v4 (button, card, table, tabs, input, badge, separator, label, textarea, select), Recharts 3, lucide-react, @anthropic-ai/sdk v0.74.0
**Established patterns:** oklch color space, Card components for data sections, Table for tabular data, Badge for status indicators, formatCurrency helper, KPI card pattern from Dashboard
**Constraining decisions:**
- Phase 02-01: oklch string literals for Recharts fills
- Phase 02-03: Bare h1/p header pattern
- Phase 03-01: Claude returns JSON in ```json fences; streamedText stored in state; EventParams and AIContext types defined
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parse JSON response and build structured result display</name>
  <files>src/pages/AIScopingPage.tsx, src/types/ai-context.ts</files>
  <action>
After streaming completes, parse the Claude response:

1. **JSON extraction:** Extract JSON from the response text. Claude wraps it in ```json ... ``` fences. Use a regex to extract the JSON block: match between ```json and ```. Parse with JSON.parse(). If parsing fails, fall back to showing the raw streamed text with a warning badge "Could not parse structured response."

2. **Add TypeScript interface** for the parsed response in `src/types/ai-context.ts`:
   ```
   interface ScopeEstimate {
     summary: string
     staffing: StaffingItem[]
     costBreakdown: CostBreakdownItem[]
     totalEstimate: { low: number; mid: number; high: number }
     confidenceNotes: string[]
     marginRecommendation: { suggestedMarginPct: number; rationale: string }
   }
   interface StaffingItem { role: string; quantity: number; days: number; dailyRate: number; totalCost: number; rationale: string }
   interface CostBreakdownItem { section: string; estimatedCost: number; percentOfTotal: number; notes: string }
   ```

3. **Replace the raw text display** with a structured layout (only shown after streaming completes and JSON parses successfully). During streaming, continue showing the raw accumulating text.

4. **Layout — vertical stack of Cards:**

   a. **Summary Card** — The `summary` text in a prominent Card with a Sparkles icon header. Use slightly larger text (text-lg).

   b. **Total Estimate Card** — Three KPI-style boxes side-by-side (Low / Mid / High) using the same pattern as Dashboard KPI cards. Mid estimate emphasized (larger font, primary color). Use formatCurrency helper (copy from DashboardPage or extract to shared util).

   c. **Staffing Recommendations Table** — shadcn Table in a Card. Columns: Role, Qty, Days, Daily Rate, Line Total, Rationale. Footer row with total staffing cost. Format currency values.

   d. **Cost Breakdown by Section** — shadcn Table in a Card. Columns: Section, Estimated Cost, % of Total, Notes. Use a subtle horizontal bar (inline div with width based on percentOfTotal) for visual weight. Footer with grand total.

   e. **Confidence & Assumptions Card** — Bulleted list of confidenceNotes with an AlertTriangle icon header. Use muted styling to indicate these are caveats.

   f. **Margin Recommendation Card** — Single Card showing suggestedMarginPct as a large number with the rationale text below. Use emerald/green accent for the percentage.

5. **Proof-of-concept banner** at the top of the results: A subtle info banner (blue-50 bg, blue border-l-4) stating: "AI-Generated Estimate — Based on analysis of [totalEvents] historical DriveShop events. This is a proof-of-concept demonstration." Use the totalEvents from AIContext.

6. **"New Estimate" button** — After results display, show a button to reset the form and clear results. Use ghost variant.

Keep all display logic in AIScopingPage.tsx. Do NOT create separate components — this is a prototype and the page should be self-contained like DashboardPage.tsx.
  </action>
  <verify>npm run build passes; npm run lint passes; after generating a scope estimate, the structured display shows all 6 sections with proper formatting</verify>
  <done>Streaming shows raw text during generation. After completion, JSON is parsed and displayed as: summary, total estimate (3 KPIs), staffing table, cost breakdown table, confidence notes, margin recommendation. Fallback to raw text if JSON parsing fails. Proof-of-concept banner shown. New Estimate button resets state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI Scoping Assistant with form input, Claude API streaming, and structured result display</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Ensure .env file has VITE_ANTHROPIC_API_KEY set with a valid key
    3. Navigate to AI Scoping Assistant in sidebar
    4. Fill out the form: Event Type = "Ride & Drive", Duration = 3, Attendance = 500, Location = "Los Angeles", Budget = "$50K-$100K", all sections checked
    5. Click "Generate Scope Estimate"
    6. Confirm: Text streams in real-time during generation
    7. Confirm: After streaming, structured display appears with:
       - Proof-of-concept banner at top
       - Summary card
       - Low/Mid/High estimate KPIs
       - Staffing table with roles, quantities, rates
       - Cost breakdown table by section
       - Confidence notes
       - Margin recommendation
    8. Click "New Estimate" — form resets, results clear
    9. Test error: Remove API key from .env, restart dev server, submit form — error message appears
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] JSON response parsing works (extracts from ```json fences)
- [ ] All 6 display sections render with proper formatting
- [ ] Fallback to raw text on JSON parse failure
- [ ] Proof-of-concept banner shows with event count
- [ ] New Estimate button resets form and results
- [ ] Currency formatting consistent with Dashboard
- [ ] Enterprise aesthetic maintained (no playful styling)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or lint errors
- AI Scoping Assistant works end-to-end: form → streaming → structured display
- Professional enterprise presentation quality
- Phase 3 complete, ready for Phase 4 polish
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-scoping-assistant/03-02-SUMMARY.md`

Update .planning/STATE.md:
- Current Position: Phase 3 complete
- Progress: 75%

Update .planning/ROADMAP.md:
- Phase 3 plans checked off
- Phase 3 status: Complete
</output>
