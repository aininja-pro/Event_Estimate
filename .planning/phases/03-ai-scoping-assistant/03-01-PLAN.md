---
phase: 03-ai-scoping-assistant
plan: 01
type: execute
---

<objective>
Build the event input form and Claude API integration with streaming responses.

Purpose: Create the data collection interface and AI backend that powers the hero "AI Scoping Assistant" — the proof-of-concept that historical event data can drive intelligent scope recommendations.
Output: Working form that collects event parameters, sends them to Claude API with historical context, and streams the response in real-time.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

# Key source files:
@src/pages/AIScopingPage.tsx
@src/types/ai-context.ts
@src/lib/data.ts
@src/data/ai-context.json
@src/pages/DashboardPage.tsx
@src/pages/RateCardPage.tsx
@.env.example

**Tech stack available:** Vite 7, React 19, TypeScript, Tailwind CSS v4, shadcn/ui v4 (button, card, table, tabs, input, badge, separator), Recharts 3, lucide-react, @anthropic-ai/sdk v0.74.0, react-router-dom
**Established patterns:** oklch color space theme vars, @/ path alias, typed JSON imports via Vite, accessor functions in src/lib/data.ts, bare h1/p headers (not Card wrappers) for page titles, module-level data loading
**Constraining decisions:**
- Phase 01-01: oklch color space for theme; shadcn/ui New York style
- Phase 01-02: BrowserRouter in App.tsx; sidebar theme CSS variables
- Phase 01-03: Pre-computed JSON data files with typed accessors; ai-context.json has historical averages for sections, roles, segments
- PROJECT.md: API key via VITE_ANTHROPIC_API_KEY env var; model claude-sonnet-4-20250514; enterprise B2B aesthetic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build event parameter input form</name>
  <files>src/pages/AIScopingPage.tsx, src/types/ai-context.ts</files>
  <action>
Replace the placeholder AIScopingPage with a structured event input form. Use the same page header pattern as Dashboard/RateCard (bare h1 + p subtitle, no Card wrapper for the header).

Form fields (all in a Card):
- **Event Name** (text input) — optional, for labeling the estimate
- **Event Type** (select/dropdown) — options: Auto Show, Ride & Drive, Brand Activation, Product Launch, Corporate Event, Experiential Marketing, Other
- **Duration** (number input) — days, 1-14 range
- **Estimated Attendance** (number input) — headcount
- **Location/Market** (text input) — city/venue
- **Budget Range** (select) — Under $10K, $10K-$25K, $25K-$50K, $50K-$100K, $100K+
- **Sections to Include** (checkboxes) — use the 7 section names from ai-context.json: PLANNING & ADMINISTRATION, ACCESS/SPONSORSHIP FEES, ONSITE LABOR ACTIVITY, TRAVEL EXPENSES, CREATIVE COSTS, PRODUCTION EXPENSES, LOGISTICS EXPENSES. Default all checked.
- **Special Requirements** (textarea) — optional free-text for specific needs

Layout: Two-column grid for the shorter fields (event type + duration on one row, attendance + location on another, budget range full-width), checkboxes as a wrapped flex row, textarea full-width at bottom. Submit button "Generate Scope Estimate" with Sparkles icon from lucide-react, styled with primary color.

Use React useState for all form fields. Add a shadcn Label component — install it first with `npx shadcn@latest add label`. Also install `npx shadcn@latest add textarea` and `npx shadcn@latest add select` for the dropdown and textarea.

Do NOT add form validation beyond HTML required attributes on Event Type, Duration, and Attendance. Keep it simple for demo.
  </action>
  <verify>npm run build passes; dev server shows form at /ai-scoping route with all fields rendering correctly</verify>
  <done>Form renders with all specified fields, two-column layout, submit button with icon. Label, Textarea, Select shadcn components installed. Form state managed via useState.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Claude API integration with streaming</name>
  <files>src/pages/AIScopingPage.tsx, src/lib/ai.ts</files>
  <action>
Create `src/lib/ai.ts` with:

1. **Anthropic client initialization:**
   ```
   new Anthropic({ apiKey: import.meta.env.VITE_ANTHROPIC_API_KEY, dangerouslyAllowBrowser: true })
   ```

2. **System prompt builder function** — `buildSystemPrompt(context: AIContext): string`
   Constructs a system prompt that:
   - Identifies Claude as a DriveShop event scoping specialist
   - Injects the historical data context (totalEvents, eventsWithRecap, dateRange, sections with avg costs, top 20 roles with rate ranges, revenue segments)
   - Instructs Claude to respond with a specific JSON structure (see below)
   - Tells Claude to base recommendations on the historical data patterns
   - Frames output as "data-backed recommendations" not guarantees

3. **Expected response JSON structure** (instruct Claude to return valid JSON wrapped in ```json fences):
   ```json
   {
     "summary": "Brief 2-3 sentence scope overview",
     "staffing": [
       { "role": "Role Name", "quantity": 2, "days": 3, "dailyRate": 850, "totalCost": 5100, "rationale": "Why this role/count" }
     ],
     "costBreakdown": [
       { "section": "ONSITE LABOR ACTIVITY", "estimatedCost": 45000, "percentOfTotal": 35, "notes": "Based on..." }
     ],
     "totalEstimate": { "low": 80000, "mid": 95000, "high": 115000 },
     "confidenceNotes": ["Note about data backing", "Note about assumptions"],
     "marginRecommendation": { "suggestedMarginPct": 15, "rationale": "Based on historical..." }
   }
   ```

4. **Streaming API call function** — `streamScopeEstimate(params: EventParams, context: AIContext, onChunk: (text: string) => void): Promise<string>`
   - Uses `anthropic.messages.stream()` with model `claude-sonnet-4-20250514`, max_tokens 4096
   - Builds user message from form params (event type, duration, attendance, location, budget, sections, special requirements)
   - Calls `onChunk` for each text delta for real-time streaming display
   - Returns the complete accumulated response text
   - Handle errors: if no API key, throw clear error; if API fails, throw with message

5. **In AIScopingPage.tsx:**
   - On form submit, call `streamScopeEstimate` passing form values and `getAIContext()`
   - Track state: `isLoading`, `streamedText`, `error`
   - During streaming, show the raw text accumulating in a Card below the form (monospace font, whitespace pre-wrap)
   - On error, show error message in a red-bordered Card
   - Disable submit button during loading, show Loader2 spinner icon
   - Store complete response text in state for Plan 03-02 to parse and display

Create an `EventParams` interface in `src/lib/ai.ts` and export it.

Do NOT use a proxy server — direct browser-to-API with dangerouslyAllowBrowser is acceptable for this demo prototype. The PROJECT.md explicitly calls for this approach.
  </action>
  <verify>npm run build passes with no TypeScript errors; npm run lint passes; with a valid API key in .env, submitting the form streams a response from Claude in real-time</verify>
  <done>Claude API call works end-to-end: form submit → streaming response displayed in real-time. Error states handled (no API key, API failure). Loading spinner shows during generation. Response text accumulated and stored in state.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Form renders at /ai-scoping with all fields
- [ ] shadcn label, textarea, select components installed
- [ ] With valid API key: submit form → streaming response appears
- [ ] Without API key: clear error message shown
- [ ] Loading state shows spinner, disables button during generation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript or lint errors introduced
- Form collects event parameters with proper layout
- Claude API integration streams responses with historical data context
- Error handling covers missing API key and API failures
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-scoping-assistant/03-01-SUMMARY.md`
</output>
